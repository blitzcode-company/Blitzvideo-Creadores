<app-header></app-header>
<div class="containerHome" [class.collapsed]="sidebarCollapsed$ | async">
  <div class="sidebar-container">
    <div class="sidebar" *ngIf="canalNombre">
      <div class="profile-section">
        <img *ngIf="!usuario?.foto" class="fotoPerfilDefault" src="assets/images/user.png" alt="Perfil">
        <img *ngIf="usuario?.foto" class="fotoPerfil" [src]="usuario.foto" alt="Perfil">
        <h1 class="channel-name">{{ canalNombre }}</h1>
      </div>
      <hr class="lineaSideBar">
      <nav class="menu-nav">
        <a class="menu-item" routerLink="/misVideos" routerLinkActive="active">
          <mat-icon>video_library</mat-icon>
          <span>Mis videos</span>
        </a>
        <a class="menu-item active" routerLink="/subirVideo">
          <mat-icon>cloud_upload</mat-icon>
          <span>Subir video</span>
        </a>
        <a class="menu-item" routerLink="/crearStream">
          <mat-icon>live_tv</mat-icon>
          <span>Crear stream</span>
        </a>
      </nav>
    </div>
  </div>

<div class="content-wrapper">
    <div class="upload-page">

      <div class="upload-header">
  
        <h1>Subir video</h1>
        <div class="flex-grow"></div>
      </div>

      <div *ngFor="let a of alerta" class="alert-banner" [ngClass]="a.type">
        {{ a.message }}
        <button mat-icon-button (click)="cerrarAlerta(a)">
          <mat-icon>close</mat-icon>
        </button>
      </div>

      <div class="video-upload-zone"
           appDragDrop
           (fileDropped)="onVideoUpload($event)"
           [class.has-video]="!!videoFile"
           [class.uploading]="uploading">

        <div class="drop-prompt" *ngIf="!videoFile && !uploading">
          <mat-icon class="big-icon">cloud_upload</mat-icon>
          <h2>Arrastra tu video aquí</h2>
          <p>o haz clic para seleccionar</p>
          <input #videoFileInput type="file" accept="video/*" (change)="onVideoUpload($event)" class="hidden-input" style="display: none;">
          <button mat-raised-button color="primary" class="select-btn" (click)="videoFileInput.click()">
            Seleccionar archivo
          </button>
        </div>

        <div class="video-preview-container" *ngIf="videoFile && !uploading">
          <video [src]="videoPreview" controls class="video-element"></video>
          <div class="video-info">
            <div class="file-name">{{ videoFile.name }}</div>
            <div class="file-size">{{ formatBytes(videoFile.size) }}</div>
          </div>
          <button mat-icon-button class="remove-btn" (click)="removeVideo()">
            <mat-icon>delete</mat-icon>
          </button>
        </div>

        <div class="uploading-overlay" *ngIf="uploading">
          <mat-progress-spinner diameter="80" mode="determinate" [value]="uploadProgress"></mat-progress-spinner>
          <h3>Subiendo... {{ uploadProgress }}%</h3>
          <p>No cierres esta pestaña</p>
        </div>
      </div>

      <div class="details-card" *ngIf="videoFile && !uploading">
        <form #uploadForm="ngForm" (ngSubmit)="onSubmit(uploadForm)">

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Título</mat-label>
            <input matInput [(ngModel)]="titulo" name="titulo" required maxlength="100">
            <mat-hint align="end">{{ titulo.length }}/100</mat-hint>
            <mat-error *ngIf="uploadForm.controls['titulo']?.hasError('required')">
              El título es obligatorio
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Descripción</mat-label>
            <textarea matInput 
                      [(ngModel)]="descripcion" 
                      name="descripcion" 
                      required 
                      rows="5"
                      placeholder="Cuéntales a los espectadores de qué trata tu video...">
            </textarea>
            <mat-error *ngIf="uploadForm.controls['descripcion']?.hasError('required')">
              La descripción es obligatoria
            </mat-error>
          </mat-form-field>

          <div class="thumbnail-section">
            <p>Miniatura <span class="optional">(opcional)</span></p>
            <label class="thumbnail-upload-box" [class.has-thumb]="!!thumbnailPreview">
              <input type="file" accept="image/*" (change)="onThumbnailUpload($event)" hidden>
              <div class="placeholder" *ngIf="!thumbnailPreview">
                <mat-icon>add_photo_alternate</mat-icon>
                <span>Subir miniatura personalizada</span>
              </div>
              <img *ngIf="thumbnailPreview" [src]="thumbnailPreview" class="thumb-preview">
              <div class="overlay" *ngIf="thumbnailPreview">
                <mat-icon>edit</mat-icon>
                <span>Cambiar</span>
              </div>
            </label>
            <small>Si no subes una, el sistema generará una automáticamente</small>
          </div>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Etiquetas</mat-label>
            <mat-select [(ngModel)]="etiquetasSeleccionadas" name="etiquetas" multiple placeholder="Selecciona etiquetas">
              <mat-option *ngFor="let e of etiquetasPlanas" [value]="e.id">
                {{ e.nombre }}
              </mat-option>
            </mat-select>
          </mat-form-field>

          <div class="action-buttons">
            <button mat-button type="button" (click)="removeVideo()">Cancelar</button>
            <button mat-raised-button color="primary" type="submit" [disabled]="!uploadForm.valid || uploading">
              <mat-icon>publish</mat-icon>
              Publicar video
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>